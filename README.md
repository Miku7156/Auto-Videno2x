# Auto-Videno2x 视频质量增强工具

## Auto-Videno2x (Windows版)

Auto-Videno2x 是一款功能强大的自动化视频质量增强工具，能够扫描指定目录下的视频文件，根据文件名相似度自动分类，并使用 Video2X 进行分辨率提升和帧率增强处理。该工具特别适合批量处理电视剧、动漫等有序媒体文件集，并提供智能调度和资源管理功能。
配合AutoBangumi使用，能够自动识别并处理AutoBangumi下载的视频文件，无需手动操作。
配合windows任务计划程序，能够定时自动执行视频质量增强处理，无需人工干预。
适合定时在空闲时间执行，自动处理AutoBangumi下载的视频文件，提升视频质量。
## 核心功能

1. **智能视频扫描**：深度扫描指定目录，识别多种视频格式（MP4、MKV、AVI等）
2. **自动元数据提取**：从文件名中识别季度(Sxx)和集数(Exx)信息
3. **智能文件分组**：基于文件名相似度（Levenshtein距离算法）自动将相似文件分组
4. **处理优先级排序**：根据文件修改时间智能计算处理优先级，优先处理最新的剧集
5. **分辨率增强**：使用libplacebo和anime4k-v4-a+a着色器提升视频分辨率
6. **帧率增强**：使用RIFE算法将视频帧率提升2倍，使画面更加流畅
7. **自动文件管理**：处理完成后自动将增强视频移至原目录并清理临时文件
8. **结果持久化**：将扫描和处理状态保存到JSON文件，支持增量处理
9. **智能调度控制**：
   - **星期几限制**：可配置仅在指定的星期几执行视频增强处理
   - **GPU占用度检查**：当GPU占用超过设定阈值时自动暂停处理，避免系统资源过度占用
10. **自动关机功能**：任务完成后可自动关闭计算机（可配置开关）

## 项目结构
```
Auto-Videno2x/
├── app.py              # 主程序文件
├── config.ini          # 配置文件
├── requirements.txt    # 依赖说明
├── README.md           # 本说明文档
├── data/               # 扫描结果存储目录
├── log/                # 日志文件目录
└── tmp/                # 临时文件目录
```

## 环境要求
- Python 3.6+
- Video2X 安装（用于视频质量增强）
- NVIDIA GPU（推荐，用于视频增强和占用度检查）
- 注：本项目主要使用Python标准库实现核心功能

## 配置说明

编辑`config.ini`文件进行如下配置：

```ini
[Logs]
MaxLogLines = 6000     # 日志文件最大行数限制

[Processing]
EnableResolutionEnhancement = false  # 是否启用分辨率增强
EnableFrameEnhancement = false       # 是否启用帧率增强

[ResolutionEnhancement]
ResolutionWidth = 3840  # 增强后的宽度
ResolutionHeight = 2160 # 增强后的高度
Processor = libplacebo  # 分辨率增强处理器
Shader = anime4k-v4-a+a # 使用的着色器
Encoder = hevc_nvenc    # 编码器
EncoderPreset = p7      # 编码预设
EncoderCRF = 24         # 编码质量因子

[FrameEnhancement]
FrameMultiplier = 2     # 帧率倍增系数
Processor = rife        # 帧率增强处理器
RifeModel = rife-v4.6   # RIFE模型版本
Encoder = hevc_nvenc    # 编码器
EncoderPreset = p7      # 编码预设
EncoderCRF = 26         # 编码质量因子
Threads = 30            # 处理线程数

[PATHS]
LogDir = log            # 日志目录
TmpDir = tmp            # 临时文件目录
DataDir = data          # 数据存储目录
ScanPath = Z:\          # 要扫描的视频目录
Video2xPath = C:\App\Video2X Qt6\video2x.exe # Video2X可执行文件路径

[Schedule]
AllowedDays = 1-7       # 允许执行的星期天数范围（1-7，1表示周一，7表示周日）
GpuUsageThreshold = 50  # 允许执行的最大GPU占用度百分比
AutoShutdown = false    # 任务完成后是否自动关机（true/false）
```

## 使用方法

1. 安装Video2X并确保在config.ini中正确配置其路径
2. 配置扫描路径、视频增强参数、执行时间和系统设置
3. 打开终端，进入项目目录
4. 运行命令：`python app.py`
5. 程序将自动：
   - 检查当前是否在允许的星期几范围内
   - 检查GPU占用度是否在允许范围内
   - 扫描指定目录下的视频文件
   - 识别和分组视频文件
   - 处理最近6天修改的视频文件
   - 生成增强后的高质量视频
   - 根据配置决定是否自动关机

## 输出文件命名规则

增强后的视频文件将以如下格式命名并存放在原目录：
```
[原文件名] [分辨率宽度]x[分辨率高度] fpsx[帧率倍数] Viden2x_HQ.[原扩展名]
例如：Example_S01E01 3840x2160 fpsx2 Viden2x_HQ.mp4
```

## 处理状态

视频文件的处理状态通过JSON文件中的"处理步骤"字段标识：
- 0: 未处理
- 1: 已筛选（最近6天修改）
- 2: 已完成分辨率增强
- 3: 已完成帧率增强，处理完成

## 调度控制说明

### 星期几限制
程序会检查当前日期的星期几，只有在配置的星期范围内才会执行视频处理。例如：
- `AllowedDays = 1-5`: 仅在工作日（周一到周五）执行
- `AllowedDays = 6-7`: 仅在周末（周六和周日）执行
- `AllowedDays = 1-7`: 每天都可以执行

### GPU占用度检查
程序会使用nvidia-smi获取当前GPU使用率，如果超过配置的阈值，则不会执行视频处理，以避免GPU资源过度占用。

### 自动关机功能
任务完成后，程序可以根据配置自动关闭计算机，适合在夜间批量处理任务时使用。

## 处理优先级排序逻辑

Auto-Videno2x 使用一种独特的处理优先级排序算法，确保最新剧集得到优先处理：

1. **文件分组**：首先根据文件名相似度将视频文件分为不同的分支（剧集组）
2. **季度和集数识别**：从文件名中提取季度(Sxx)和集数(Exx)信息
3. **时间排序**：在同一季度和集数组合中，按照文件修改时间排序
4. **优先级计算**：统计每个分支中具有最早修改时间的文件数量
5. **优先级分配**：按照这个数量进行排序，数量多的分支优先级更高（处理优先级数字更小）

这种排序机制确保了连续剧集中最新的一集能够得到优先处理，即使它们可能分布在不同的文件格式中（如MP4和MKV）。

## 注意事项

1. 确保扫描路径和Video2X路径正确配置且具有访问权限
2. 视频增强过程较为耗时，请确保有足够的磁盘空间和处理时间
3. 程序会自动跳过已处理的文件（文件名中包含"Viden2x_HQ"的文件）
4. 日志文件会自动维护在指定行数以内，避免占用过多磁盘空间
5. 视频文件命名建议采用SxxExx格式以正确识别季度和集数信息
6. 对于GPU占用度检查功能，需要确保系统中安装了NVIDIA显卡驱动并配置了nvidia-smi工具
7. 自动关机功能在Windows系统中使用PowerShell实现，请确保程序具有足够的系统权限
8. 建议在配置完成后进行小批量测试，确保所有设置正常工作